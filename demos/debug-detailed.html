<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Flag Simulation</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #222;
            color: white;
        }

        h1 {
            text-align: center;
        }

        #container {
            width: 800px;
            height: 600px;
            margin: 20px auto;
            border: 2px solid #444;
            background: #111;
            position: relative;
        }

        #debug {
            width: 800px;
            margin: 0 auto;
            background: #333;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }

        .error {
            color: #ff6b6b;
        }

        .success {
            color: #51cf66;
        }

        .info {
            color: #74c0fc;
        }
    </style>
</head>

<body>
    <h1>üèÅ Debug Flag Simulation</h1>
    <div id="container"></div>
    <div id="debug"></div>

    <script type="module">
        const debugEl = document.getElementById('debug');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = type;
            div.textContent = `[${timestamp}] ${message}`;
            debugEl.appendChild(div);
            debugEl.scrollTop = debugEl.scrollHeight;
            console.log(`[${type.toUpperCase()}]`, message);
        }

        async function debugSimulation() {
            try {
                log('üöÄ Starting debug process...');

                // Try importing modules one by one
                log('üì¶ Importing World...');
                const { World } = await import('./build/src/core/ecs/World.js');
                log('‚úÖ World imported', 'success');

                log('üì¶ Importing PluginManager...');
                const { PluginManager } = await import('./build/src/core/plugin/PluginManager.js');
                log('‚úÖ PluginManager imported', 'success');

                log('üì¶ Importing StateManager...');
                const { StateManager } = await import('./build/src/studio/state/StateManager.js');
                log('‚úÖ StateManager imported', 'success');

                log('üì¶ Importing Studio...');
                const { Studio } = await import('./build/src/studio/Studio.js');
                log('‚úÖ Studio imported', 'success');

                // Create instances
                log('üèóÔ∏è Creating World instance...');
                const world = new World();
                log('‚úÖ World created', 'success');

                log('üèóÔ∏è Creating PluginManager...');
                const pluginManager = new PluginManager(world);
                log('‚úÖ PluginManager created', 'success');

                log('üèóÔ∏è Getting StateManager...');
                const stateManager = StateManager.getInstance();
                log('‚úÖ StateManager obtained', 'success');

                log('üèóÔ∏è Creating plugin context...');
                const pluginContext = {
                    studio: null,
                    world,
                    eventBus: {
                        emit: () => log('EventBus.emit called'),
                        on: () => log('EventBus.on called'),
                        off: () => log('EventBus.off called'),
                        once: () => log('EventBus.once called')
                    },
                    getStateManager: () => stateManager,
                };
                log('‚úÖ Plugin context created', 'success');

                log('üèóÔ∏è Creating Studio...');
                const studio = new Studio(world, pluginManager, stateManager, pluginContext);
                pluginContext.studio = studio;
                log('‚úÖ Studio created', 'success');

                log('üñ•Ô∏è Getting container element...');
                const container = document.getElementById('container');
                if (!container) {
                    throw new Error('Container element not found!');
                }
                log('‚úÖ Container found', 'success');

                log('üé¨ Initializing Studio with container...');
                studio.initialize(container);
                log('‚úÖ Studio initialized', 'success');

                // Check if canvas was created
                const canvas = container.querySelector('canvas');
                if (canvas) {
                    log(`‚úÖ Canvas created: ${canvas.width}x${canvas.height}`, 'success');
                } else {
                    log('‚ùå No canvas found in container!', 'error');
                }

                log('üèÅ Loading flag simulation...');
                await studio.loadSimulation('flag-simulation');
                log('‚úÖ Flag simulation loaded', 'success');

                // Check scene contents
                const graphics = studio.getGraphicsManager();
                const scene = graphics.getScene();
                const entities = world.getEntities();

                log(`üìä Scene children: ${scene.children.length}`, 'info');
                log(`üìä World entities: ${entities.length}`, 'info');

                // List scene objects
                scene.children.forEach((child, i) => {
                    log(`  ‚îî Scene[${i}]: ${child.type} "${child.name || 'unnamed'}"`, 'info');
                });

                // Start animation
                log('üé¨ Starting render loop...', 'info');
                let frameCount = 0;
                function animate() {
                    try {
                        studio.update(0.016);
                        studio.render();
                        frameCount++;

                        if (frameCount % 60 === 0) {
                            log(`üéØ Frame ${frameCount}: Still running...`, 'info');
                        }
                    } catch (error) {
                        log(`‚ùå Animation error: ${error.message}`, 'error');
                        return;
                    }
                    requestAnimationFrame(animate);
                }
                animate();

                log('üéâ Debug complete - animation running!', 'success');

            } catch (error) {
                log(`‚ùå Fatal error: ${error.message}`, 'error');
                log(`‚ùå Stack: ${error.stack}`, 'error');
                console.error(error);
            }
        }

        // Start when page loads
        window.addEventListener('load', () => {
            setTimeout(debugSimulation, 100);
        });

        // Catch any unhandled errors
        window.addEventListener('error', (event) => {
            log(`‚ùå Global error: ${event.message}`, 'error');
        });

        window.addEventListener('unhandledrejection', (event) => {
            log(`‚ùå Unhandled promise rejection: ${event.reason}`, 'error');
        });
    </script>
</body>

</html>
